# Extended make file for qubes-builder
#
# Used for projects by Jason Mehring (nrgaway)

################################################################################
#             E X T R A   M A K E F I L E   T A R G E T S
################################################################################

# Get rid of quotes
TEMPLATE_FLAVOR := $(shell echo $(TEMPLATE_FLAVOR))
WHONIX_DIR := $(shell echo $(WHONIX_DIR))
DEPENDENCIES := $(shell echo $(DEPENDENCIES))

ifneq (,$(findstring wheezy+whonix,$(DISTS_VM)))
WHONIX := 1
else
COMPONENTS := $(filter-out Whonix qubes-whonix, $(COMPONENTS))
TEMPLATE := $(filter-out Whonix qubes-whonix, $(TEMPLATE))
endif

.PHONY: umount
umount:
	@dir="$$(readlink -m .)"; \
	./scripts-debian/umount_kill.sh "$$dir/qubes-src/"; \
	for dist in $(DISTS_VM) $(DIST_DOM0); do \
	    dist=$${dist%%+*}; \
	    ./scripts-debian/umount_kill.sh "$$dir/chroot-$$dist"; \
	done;

.PHONY: patch
patch::
	@echo "Applying pathces..."; \
	# whonix-setup-wizard and depend python-guimessages are not yet in main Whonix
	# repo, so we need to build them in Qubes
	repos=$(addprefix qubes-src/,"whonix-setup-wizard python-guimessages qubes-whonix"); \
	for repo in $$repos; do \
	    if [ -d "$$repo" ] && ! [ -f "$$repo/Makefile.builder" ]; then \
	        @echo "Applying whonix-setup-wizard pathces to $$repo..."; \
	        pushd "$$repo"; \
	        git branch template-builder; \
	        git checkout template-builder; \
	        cp -pf ../../scripts-debian/Makefile.debian Makefile; \
	        cp -pf ../../scripts-debian/Makefile.builder . ; \
	        cp -pf ../../scripts-debian/make-helper.bsh . ; \
	        cp -pf ../../scripts-debian/debian-parser . ; \
	        git add Makefile.builder debian-parser; \
	        git commit -a -m 'Added Qubes Makefile.builder'; \
	        popd; \
	    fi; \
	done

.PHONY: install-deps
install-deps::
	@sudo yum install -y $(DEPENDENCIES)

.PHONY: get-sources
#get-sources:: umount install-deps nrgaway-keyring
get-sources:: umount install-deps 
	# Whonix Keyring
	@if [ "$$WHONIX" == "1" ]; then \
	    # calling verify-git-tag.sh will create keyrings dir and add developer keys
	    dir="$$(readlink -m .)"; \
	    KEYRING_DIR_GIT="$$dir/keyrings/git"; \
	    export GNUPGHOME="$$(readlink -m $$KEYRING_DIR_GIT)"; \
	    ./verify-git-tag.sh; \
	    echo '916B8D99C38EAF5E8ADC7A2A8D66066A2EEACCDA:6:' | gpg --import-ownertrust; \
	    gpg --import keys_debian/whonix-developer-patrick.asc; \
	    gpg --list-keys; \
	    touch "$$GNUPGHOME/pubring.gpg"; \
	fi; \

.PHONY: template-modules
template-modules:: umount patch $(addsuffix -vm,$(TEMPLATE))
	@echo "Creating template(s)..."
	#@if [ "$$WHONIX" == "1" ]; then \
	#    make -C qubes-src/Whonix get-sources verify-sources; \
	#fi;

.PHONY: template
template:: umount
	@echo "DISTS_VM    = $(DISTS_VM)"
	@echo "DISTS_ALL   = $(DISTS_ALL)"
	@echo "DIST_DOM0   = $(DIST_DOM0)"
	@echo "TEMPLATE    = $(TEMPLATE)"
	@echo "COMPONENTS  = $(COMPONENTS)"
	$(MAKE) $(TEMPLATE)
	exit 0

#.PHONY: clean-rpms 
clean-rpms:: clean-installer-rpms
	@for dist in $(shell ls qubes-rpms-mirror-repo/); do \
	    echo "Cleaning up debs in qubes-rpms-mirror-repo/$$dist/dists/..."; \
	    sudo rm -rf qubes-rpms-mirror-repo/$$dist/dists/* || true ;\
	    echo "Cleaning up debs in qubes-rpms-mirror-repo/$$dist/deb/..."; \
	    sudo rm -rf qubes-rpms-mirror-repo/$$dist/deb/* || true ;\
	done
	@echo 'Cleaning up deb in qubes-src/*/deb/*...'; \
	sudo rm -rf qubes-src/*/deb/* || true;

# Does a regular clean as well as removes all prepared and created tempalte
# images and chroot-*
# About the only items left in tact are is the qubes-src directory tree
.PHONY: mostlyclean
mostlyclean:: umount clean clean-rpms
	@dir="$$(readlink -m .)"; \
	pkgdir="$$dir/qubes-src/linux-template-builder"; \
	if [ -d "$$pkgdir" ] ; then \
	    pushd "$$pkgdir"; \
	    sudo rm -rf prepared_images/*  || true; \
	    sudo rm -rf qubeized_images/*  || true; \
	    sudo rm -rf rpm/noarch/*  || true; \
	    sudo rm -rf yum_repo_qubes/* || true; \
	    popd; \
	fi; \
	dists=(); \
	for dist in $(DISTS_VM) $(DIST_DOM0) "chroot-debian"; do \
	    dist=$${dist%%+*}; \
	    if [[ ! $${dists[@]} =~ $$dist ]] ; then \
	        dists+=("$${dist}"); \
	        sudo rm -rf $$dir/chroot-$$dist || true; \
	    fi; \
	done; \
	sudo rm -rf $$dir/qubes-rpms-mirror-repo/repodata/* || true;

.PHONY: clean-chroot
clean-chroot:: 
	@dists="$(shell ls -d chroot-*)"; \
	for dist in $$dists; do \
	    ./scripts-debian/umount_kill.sh "$$dist"; \
	    sudo rm -rf "$$dist"; \
	done; \

.PHONY: clean-all
clean-all:: umount clean-chroot
	@dir="$$(readlink -m .)"; \
	sudo rm -f $$dir/qubes-rpms-mirror-repo/repodata/* || true;

#.PHONY: nrgaway-keyring
#nrgaway-keyring::
#	# nrgaway Keyring
#	# calling verify-git-tag.sh will create keyrings dir and add developer keys
#	@dir="$$(readlink -m .)"; \
#	KEYRING_DIR_GIT="$$dir/keyrings/git"; \
#	export GNUPGHOME="$$(readlink -m $$KEYRING_DIR_GIT)"; \
#	./verify-git-tag.sh; \
#	echo 'E0E32283FDCAC1A510078F271BB9B1FB5A4C6DAD:6:' | gpg --import-ownertrust; \
#	gpg --import nrgaway-qubes-signing-key.asc; \
#	gpg --list-keys; \
#	touch "$$GNUPGHOME/pubring.gpg"

# Returns variable value
# Example usage: GET_VAR=DISTS_VM make get-var
.PHONY: get-var
get-var::
	@GET_VAR=$${!GET_VAR}; \
	echo "$${GET_VAR}"

about::
	@echo "extended-rules.conf"

